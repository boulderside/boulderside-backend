name: Deploy to EC2

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: boulderside
      IMAGE_TAG: ${{ github.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: 'gradle'

      - name: Run tests
        run: ./gradlew test

      - name: Build Docker image
        run: docker build -t $IMAGE_NAME:$IMAGE_TAG .

      - name: Save Docker image
        run: docker save $IMAGE_NAME:$IMAGE_TAG | gzip > image.tar.gz

      - name: Prepare deployment files
        run: |
          echo "${{ secrets.PROD_ENV }}" > prod.env
          echo "DOCKER_IMAGE=$IMAGE_NAME:$IMAGE_TAG" >> prod.env
          printf "%s" "${{ secrets.APPLE_P8_BASE64 }}" > apple_authkey.p8
          printf "%s" "${{ secrets.SERVICE_JSON_BASE64 }}" | base64 -d > service.json

      - name: Deploy to EC2
        run: |
          echo "${{ secrets.EC2_SSH_KEY }}" > key.pem
          chmod 600 key.pem

          scp -o StrictHostKeyChecking=no -i key.pem \
            image.tar.gz prod.env apple_authkey.p8 service.json docker-compose.prod.yml \
            ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~

          ssh -o StrictHostKeyChecking=no -i key.pem ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} << 'EOF'
            set -e

            # 이미지 로드
            docker load < ~/image.tar.gz
            rm ~/image.tar.gz

            # 파일 이동
            mkdir -p ~/boulderside
            mv ~/prod.env ~/apple_authkey.p8 ~/service.json ~/docker-compose.prod.yml ~/boulderside/
            cd ~/boulderside

            # 재배포
            docker compose --env-file prod.env -f docker-compose.prod.yml down || true
            docker compose --env-file prod.env -f docker-compose.prod.yml up -d

            # 정리
            docker image prune -af --filter "until=72h"
          EOF

          rm key.pem